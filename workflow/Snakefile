from os import getcwd, makedirs, walk
from os.path import basename, exists, join
from tempfile import gettempdir
from shutil import rmtree
from urllib.parse import urlparse

import numpy as np
import pandas as pd

CONFIG_DIR = "config"
DATA_DIR = "data"
LOG_DIR = "logs"
RESOURCES_DIR = "resources"
RESULTS_DIR = "results"
RULES_DIR = "rules"


configfile: join(CONFIG_DIR, "config.yaml")


STUDY_NAME = config["study"]

TEMP_DIR = config["tmp_dir"] if config["tmp_dir"] else gettempdir()

EXPAND_PARAMS = {}

PUBLIC_WRAPPERS_VERSION = config["wrappers"]["public"]["version"]
PERSONAL_WRAPPERS_BASE_URL = config["wrappers"]["personal"]["base_url"]
LOCAL_WRAPPERS_BASE_URL = config["wrappers"]["local"]["base_url"]

HOST_REF_FASTA_URL = config["resources"]["ref"]["fasta_url"]
HOST_REF_FASTA_FILE = join(
    RESOURCES_DIR, "ref", basename(urlparse(HOST_REF_FASTA_URL).path)
)

GDC_METADATA_DIR = config["gdc"]["metadata"]["data_dir"]
GDC_METADATA_LOG_DIR = config["gdc"]["metadata"]["log_dir"]
GDC_BAM_META_FILENAME = config["gdc"]["metadata"]["file_meta_filename"]
GDC_BAM_META_FILE = join(GDC_METADATA_DIR, GDC_BAM_META_FILENAME)
GDC_READGRP_META_FILENAME = config["gdc"]["metadata"]["readgrp_meta_filename"]
GDC_READGRP_META_FILE = join(GDC_METADATA_DIR, GDC_READGRP_META_FILENAME)

KRAKEN2_DB_LIBS = config["resources"]["db"]["kraken2"]["libs"]
KRAKENUNIQ_DB_LIBS = config["resources"]["db"]["krakenuniq"]["libs"]
BRACKEN_DB_READ_LENGTHS = config["resources"]["db"]["bracken"]["readlens"]

KRAKEN_DB_BASEDIR = config["resources"]["db"]["base_dir"]
KRAKEN_DB_NAME = config["resources"]["db"]["name"]

KRAKEN2_TSEARCH_UNCLASSIF = config["kraken2"]["build"]["tsearch_unclassif"]

KRAKEN2_DB_TYPES = ["nucl", "prot"] if KRAKEN2_TSEARCH_UNCLASSIF else ["nucl"]

KRAKEN_MODE = config["read_classif"]["mode"]

EXPAND_PARAMS["k2dtype"] = KRAKEN2_DB_TYPES
EXPAND_PARAMS["k2nlib"] = KRAKEN2_DB_LIBS
EXPAND_PARAMS["k2plib"] = [
    l
    for l in KRAKEN2_DB_LIBS
    if l not in config["resources"]["db"]["kraken2"]["nucl_only"]
]
EXPAND_PARAMS["kulib"] = KRAKENUNIQ_DB_LIBS
EXPAND_PARAMS["readlen"] = BRACKEN_DB_READ_LENGTHS

makedirs(GDC_METADATA_LOG_DIR, mode=0o755, exist_ok=True)
GDC_METADATA_LOG = join(GDC_METADATA_LOG_DIR, "gdc_metadata.log")
with open(GDC_METADATA_LOG, "wt") as log_fh:
    if not exists(GDC_BAM_META_FILE) or not exists(GDC_READGRP_META_FILE):
        log_fh.write("Getting GDC metadata...\n")
        makedirs(GDC_METADATA_DIR, mode=0o755, exist_ok=True)
    else:
        log_fh.write("Using existing GDC metadata\n")
if not exists(GDC_BAM_META_FILE) or not exists(GDC_READGRP_META_FILE):
    shell(f"Rscript ./workflow/scripts/gdc_metadata.R >> {GDC_METADATA_LOG} 2>&1")

GDC_BAM_META_DF = pd.read_csv(GDC_BAM_META_FILE, sep="\t").set_index(
    "file_id", drop=False, verify_integrity=True
)
GDC_READGRP_META_DF = pd.read_csv(
    GDC_READGRP_META_FILE, sep="\t", dtype={"is_paired_end": bool, "read_length": int}
).set_index("read_group_id", drop=False, verify_integrity=True)

GDC_TOKEN = os.getenv("GDC_TOKEN")
if GDC_TOKEN is None:
    GDC_TOKEN_FILE = os.getenv("GDC_TOKEN_FILE", "~/.gdc_token")
    if GDC_TOKEN_FILE is not None and exists(GDC_TOKEN_FILE):
        GDC_TOKEN_FILE = GDC_TOKEN_FILE.strip()
        with open(GDC_TOKEN_FILE, "rt") as token_fh:
            GDC_TOKEN = token_fh.readline().strip()
assert (
    GDC_TOKEN is not None
), "GDC auth token not found in GDC_TOKEN, GDC_TOKEN_FILE, or ~/.gdc_token"

GDC_RESULTS_DIR = join(RESULTS_DIR, "gdc")
GDC_LOG_DIR = join(LOG_DIR, "gdc")
GDC_FILE_RESULTS_DIR = join(GDC_RESULTS_DIR, "{level}", "{bam_id}")
GDC_FILE_LOG_DIR = join(GDC_LOG_DIR, "{level}", "{bam_id}")
GDC_UNMAPPED_BAM_FILE = join(GDC_FILE_RESULTS_DIR, "{bam_id}_unmapped.bam")
GDC_UNMAPPED_BAM_LOG = join(GDC_FILE_LOG_DIR, "{bam_id}_unmapped_bam.log")
GDC_UNMAPPED_BAM_FILES = GDC_BAM_META_DF.apply(
    lambda x: (
        join(
            GDC_RESULTS_DIR,
            "sg",
            x["file_id"],
            f"{x['file_id']}_unmapped.bam",
        )
        if x["num_uniq_read_groups"] == 1
        else join(
            GDC_RESULTS_DIR,
            "rg",
            x["file_id"],
            f"{x['file_id']}_unmapped.bam",
        )
    ),
    axis=1,
).tolist()
GDC_UNMAPPED_FASTQ_R1_FILE = join(GDC_FILE_RESULTS_DIR, "{rg_id}_unmapped_r1.fastq.gz")
GDC_UNMAPPED_FASTQ_R2_FILE = join(GDC_FILE_RESULTS_DIR, "{rg_id}_unmapped_r2.fastq.gz")
GDC_UNMAPPED_FASTQ_O1_FILE = join(GDC_FILE_RESULTS_DIR, "{rg_id}_unmapped_o1.fastq.gz")
GDC_UNMAPPED_FASTQ_O2_FILE = join(GDC_FILE_RESULTS_DIR, "{rg_id}_unmapped_o2.fastq.gz")
GDC_UNMAPPED_FASTQ_SE_FILE = join(GDC_FILE_RESULTS_DIR, "{rg_id}_unmapped_se.fastq.gz")
GDC_UNMAPPED_FASTQ_LOG = join(GDC_FILE_LOG_DIR, "{rg_id}_unmapped_fastq.log")
GDC_UNMAPPED_FASTQ_FILES = np.hstack(
    pd.concat(
        [
            GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] == 1].apply(
                lambda x: (
                    [
                        join(
                            GDC_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            f"{x['file_id']}_unmapped_r1.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            f"{x['file_id']}_unmapped_r2.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            f"{x['file_id']}_unmapped_o1.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            f"{x['file_id']}_unmapped_o2.fastq.gz",
                        ),
                    ]
                    if x["is_paired_end"]
                    else [
                        join(
                            GDC_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            f"{x['file_id']}_unmapped_se.fastq.gz",
                        )
                    ]
                ),
                axis=1,
            ),
            GDC_READGRP_META_DF[GDC_READGRP_META_DF["num_uniq_read_groups"] > 1].apply(
                lambda x: (
                    [
                        join(
                            GDC_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            f"{x['read_group_id']}_unmapped_r1.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            f"{x['read_group_id']}_unmapped_r2.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            f"{x['read_group_id']}_unmapped_o1.fastq.gz",
                        ),
                        join(
                            GDC_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            f"{x['read_group_id']}_unmapped_o2.fastq.gz",
                        ),
                    ]
                    if x["is_paired_end"]
                    else [
                        join(
                            GDC_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            f"{x['read_group_id']}_unmapped_se.fastq.gz",
                        )
                    ]
                ),
                axis=1,
            ),
        ],
        axis=0,
    )
).tolist()

BOWTIE2_RESULTS_DIR = join(RESULTS_DIR, "bowtie2")
BOWTIE2_LOG_DIR = join(LOG_DIR, "bowtie2")
BOWTIE2_HOST_INDEX_PREFIX = join(RESOURCES_DIR, "bowtie2", "genome")
BOWTIE2_HOST_INDEX_FILES = multiext(
    BOWTIE2_HOST_INDEX_PREFIX,
    ".1.bt2",
    ".2.bt2",
    ".3.bt2",
    ".4.bt2",
    ".rev.1.bt2",
    ".rev.2.bt2",
)
BOWTIE2_HOST_INDEX_LOG = join(BOWTIE2_LOG_DIR, "build", "index.log")

BOWTIE2_ALIGN_RESULTS_DIR = join(BOWTIE2_RESULTS_DIR, "align")
BOWTIE2_ALIGN_LOG_DIR = join(BOWTIE2_LOG_DIR, "align")
BOWTIE2_ALIGN_FILE_RESULTS_DIR = join(
    BOWTIE2_ALIGN_RESULTS_DIR, "{level}", "{bam_id}", "{etype}"
)
BOWTIE2_ALIGN_FILE_LOG_DIR = join(
    BOWTIE2_ALIGN_LOG_DIR, "{level}", "{bam_id}", "{etype}"
)
BOWTIE2_ALIGN_PE_FILE_RESULTS_DIR = join(
    BOWTIE2_ALIGN_RESULTS_DIR, "{level}", "{bam_id}", "pe"
)
BOWTIE2_ALIGN_SE_FILE_RESULTS_DIR = join(
    BOWTIE2_ALIGN_RESULTS_DIR, "{level}", "{bam_id}", "se"
)
BOWTIE2_ALIGN_PE_FILE_LOG_DIR = join(BOWTIE2_ALIGN_LOG_DIR, "{level}", "{bam_id}", "pe")
BOWTIE2_ALIGN_SE_FILE_LOG_DIR = join(BOWTIE2_ALIGN_LOG_DIR, "{level}", "{bam_id}", "se")
BOWTIE2_SAM_FILE = join(BOWTIE2_ALIGN_FILE_RESULTS_DIR, "{rg_id}.sam")
BOWTIE2_FILTERED_SAM_FILE = join(BOWTIE2_ALIGN_FILE_RESULTS_DIR, "{rg_id}_filtered.sam")
BOWTIE2_FILTERED_SAM_PE_FILE = join(
    BOWTIE2_ALIGN_PE_FILE_RESULTS_DIR, "{rg_id}_filtered.sam"
)
BOWTIE2_FILTERED_SAM_SE_FILE = join(
    BOWTIE2_ALIGN_SE_FILE_RESULTS_DIR, "{rg_id}_filtered.sam"
)
BOWTIE2_ALIGN_LOG = join(BOWTIE2_ALIGN_FILE_LOG_DIR, "{rg_id}_align.log")
BOWTIE2_FILTERED_SAM_FILES = pd.concat(
    [
        GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] == 1].apply(
            lambda x: join(
                BOWTIE2_ALIGN_RESULTS_DIR,
                "sg",
                x["file_id"],
                "pe" if x["is_paired_end"] else "se",
                f"{x['file_id']}_filtered.sam",
            ),
            axis=1,
        ),
        GDC_READGRP_META_DF[GDC_READGRP_META_DF["num_uniq_read_groups"] > 1].apply(
            lambda x: join(
                BOWTIE2_ALIGN_RESULTS_DIR,
                "rg",
                x["file_id"],
                "pe" if x["is_paired_end"] else "se",
                f"{x['read_group_id']}_filtered.sam",
            ),
            axis=1,
        ),
    ],
    axis=0,
).tolist()
BOWTIE2_FILTERED_FASTQ_R1_FILE = join(
    BOWTIE2_ALIGN_PE_FILE_RESULTS_DIR, "{rg_id}_filtered_r1.fastq.gz"
)
BOWTIE2_FILTERED_FASTQ_R2_FILE = join(
    BOWTIE2_ALIGN_PE_FILE_RESULTS_DIR, "{rg_id}_filtered_r2.fastq.gz"
)
BOWTIE2_FILTERED_FASTQ_SE_FILE = join(
    BOWTIE2_ALIGN_SE_FILE_RESULTS_DIR, "{rg_id}_filtered_se.fastq.gz"
)
BOWTIE2_FILTERED_FASTQ_PE_LOG = join(
    BOWTIE2_ALIGN_PE_FILE_LOG_DIR, "{rg_id}_filtered_fastq.log"
)
BOWTIE2_FILTERED_FASTQ_SE_LOG = join(
    BOWTIE2_ALIGN_SE_FILE_LOG_DIR, "{rg_id}_filtered_fastq.log"
)
BOWTIE2_FILTERED_FASTQ_FILES = np.hstack(
    pd.concat(
        [
            GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] == 1].apply(
                lambda x: (
                    [
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            "pe",
                            f"{x['file_id']}_filtered_r1.fastq.gz",
                        ),
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            "pe",
                            f"{x['file_id']}_filtered_r2.fastq.gz",
                        ),
                    ]
                    if x["is_paired_end"]
                    else [
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "sg",
                            x["file_id"],
                            "se",
                            f"{x['file_id']}_filtered_se.fastq.gz",
                        )
                    ]
                ),
                axis=1,
            ),
            GDC_READGRP_META_DF[GDC_READGRP_META_DF["num_uniq_read_groups"] > 1].apply(
                lambda x: (
                    [
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            "pe",
                            f"{x['read_group_id']}_filtered_r1.fastq.gz",
                        ),
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            "pe",
                            f"{x['read_group_id']}_filtered_r2.fastq.gz",
                        ),
                    ]
                    if x["is_paired_end"]
                    else [
                        join(
                            BOWTIE2_ALIGN_RESULTS_DIR,
                            "rg",
                            x["file_id"],
                            "se",
                            f"{x['read_group_id']}_filtered_se.fastq.gz",
                        )
                    ]
                ),
                axis=1,
            ),
        ],
        axis=0,
    )
).tolist()

KRAKEN2_RESULTS_DIR = join(RESULTS_DIR, "kraken2")
KRAKEN2_LOG_DIR = join(LOG_DIR, "kraken2")

KRAKEN2_DB_DIR = join(KRAKEN_DB_BASEDIR, KRAKEN_DB_NAME, "{k2dtype}")
KRAKEN2_NUCL_DB_DIR = join(KRAKEN_DB_BASEDIR, KRAKEN_DB_NAME, "nucl")
KRAKEN2_PROT_DB_DIR = join(KRAKEN_DB_BASEDIR, KRAKEN_DB_NAME, "prot")

KRAKEN2_DB_BUILD_LOG_DIR = join(KRAKEN2_LOG_DIR, "build", "{k2dtype}")
KRAKEN2_NUCL_DB_BUILD_LOG_DIR = join(KRAKEN2_LOG_DIR, "build", "nucl")
KRAKEN2_PROT_DB_BUILD_LOG_DIR = join(KRAKEN2_LOG_DIR, "build", "prot")

KRAKEN2_DB_TAX_DIR = join(KRAKEN2_DB_DIR, "taxonomy")
KRAKEN2_DB_TAX_LOG = join(KRAKEN2_DB_BUILD_LOG_DIR, "download_taxonomy.log")
KRAKEN2_DB_TAX_DONE_FILE = join(KRAKEN2_DB_TAX_DIR, "kraken2_taxonomy.done")

KRAKEN2_NUCL_DB_LIB_DIR = join(KRAKEN2_NUCL_DB_DIR, "library", "{k2nlib}")
KRAKEN2_NUCL_DB_LIB_LOG = join(KRAKEN2_NUCL_DB_BUILD_LOG_DIR, "download_{k2nlib}.log")
KRAKEN2_NUCL_DB_LIB_DONE_FILE = join(KRAKEN2_NUCL_DB_DIR, "kraken2_{k2nlib}.done")
KRAKEN2_PROT_DB_LIB_DIR = join(KRAKEN2_PROT_DB_DIR, "library", "{k2plib}")
KRAKEN2_PROT_DB_LIB_LOG = join(KRAKEN2_PROT_DB_BUILD_LOG_DIR, "download_{k2plib}.log")
KRAKEN2_PROT_DB_LIB_DONE_FILE = join(KRAKEN2_PROT_DB_DIR, "kraken2_{k2plib}.done")

KRAKEN2_DB_BUILD_LOG = join(KRAKEN2_DB_BUILD_LOG_DIR, "kraken2_build.log")
KRAKEN2_DB_BUILD_DONE_FILE = join(KRAKEN2_DB_DIR, "kraken2_build.done")
KRAKEN2_NUCL_DB_BUILD_DONE_FILE = join(KRAKEN2_NUCL_DB_DIR, "kraken2_build.done")
KRAKEN2_PROT_DB_BUILD_DONE_FILE = join(KRAKEN2_PROT_DB_DIR, "kraken2_build.done")

KRAKEN2_NUCL_CLASSIFY_RESULTS_DIR = join(
    KRAKEN2_RESULTS_DIR, "classify", KRAKEN_DB_NAME, "nucl"
)
KRAKEN2_NUCL_CLASSIFY_LOG_DIR = join(
    KRAKEN2_LOG_DIR, "classify", KRAKEN_DB_NAME, "nucl"
)
KRAKEN2_PROT_CLASSIFY_RESULTS_DIR = join(
    KRAKEN2_RESULTS_DIR, "classify", KRAKEN_DB_NAME, "prot"
)
KRAKEN2_PROT_CLASSIFY_LOG_DIR = join(
    KRAKEN2_LOG_DIR, "classify", KRAKEN_DB_NAME, "prot"
)

KRAKEN2_NUCL_CLASSIFY_FILE_RESULTS_DIR = join(
    KRAKEN2_NUCL_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "{etype}"
)
KRAKEN2_NUCL_REPORT_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)

KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR = join(
    KRAKEN2_NUCL_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "pe"
)
KRAKEN2_NUCL_CLASSIFY_SE_FILE_RESULTS_DIR = join(
    KRAKEN2_NUCL_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "se"
)
KRAKEN2_NUCL_CLASSIFY_PE_FILE_LOG_DIR = join(
    KRAKEN2_NUCL_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "pe"
)
KRAKEN2_NUCL_CLASSIFY_SE_FILE_LOG_DIR = join(
    KRAKEN2_NUCL_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "se"
)

KRAKEN2_NUCL_CLASSIF_FASTQ_R1_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r1.fastq.gz"
)
KRAKEN2_NUCL_CLASSIF_FASTQ_R2_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r2.fastq.gz"
)
KRAKEN2_NUCL_UNCLASSIF_FASTQ_R1_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r1.fastq.gz"
)
KRAKEN2_NUCL_UNCLASSIF_FASTQ_R2_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r2.fastq.gz"
)
KRAKEN2_NUCL_CLASSIF_FASTQ_SE_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_classif_se.fastq.gz"
)
KRAKEN2_NUCL_UNCLASSIF_FASTQ_SE_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_unclassif_se.fastq.gz"
)
KRAKEN2_NUCL_REPORT_PE_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKEN2_NUCL_REPORT_SE_FILE = join(
    KRAKEN2_NUCL_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKEN2_NUCL_CLASSIFY_PE_LOG = join(
    KRAKEN2_NUCL_CLASSIFY_PE_FILE_LOG_DIR, "{rg_id}_classify.log"
)
KRAKEN2_NUCL_CLASSIFY_SE_LOG = join(
    KRAKEN2_NUCL_CLASSIFY_SE_FILE_LOG_DIR, "{rg_id}_classify.log"
)

KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR = join(
    KRAKEN2_PROT_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "pe"
)
KRAKEN2_PROT_CLASSIFY_SE_FILE_RESULTS_DIR = join(
    KRAKEN2_PROT_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "se"
)
KRAKEN2_PROT_CLASSIFY_PE_FILE_LOG_DIR = join(
    KRAKEN2_PROT_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "pe"
)
KRAKEN2_PROT_CLASSIFY_SE_FILE_LOG_DIR = join(
    KRAKEN2_PROT_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "se"
)

KRAKEN2_PROT_CLASSIF_FASTQ_R1_FILE = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r1.fastq.gz"
)
KRAKEN2_PROT_CLASSIF_FASTQ_R2_FILE = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r2.fastq.gz"
)
KRAKEN2_PROT_UNCLASSIF_FASTQ_R1_FILE = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r1.fastq.gz"
)
KRAKEN2_PROT_UNCLASSIF_FASTQ_R2_FILE = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r2.fastq.gz"
)
KRAKEN2_PROT_CLASSIF_FASTQ_SE_FILE = join(
    KRAKEN2_PROT_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_classif_se.fastq.gz"
)
KRAKEN2_PROT_UNCLASSIF_FASTQ_SE_FILE = join(
    KRAKEN2_PROT_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_unclassif_se.fastq.gz"
)
KRAKEN2_PROT_REPORT_PE_FILE = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKEN2_PROT_REPORT_SE_FILE = join(
    KRAKEN2_PROT_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKEN2_PROT_CLASSIFY_PE_LOG = join(
    KRAKEN2_PROT_CLASSIFY_PE_FILE_LOG_DIR, "{rg_id}_classify.log"
)
KRAKEN2_PROT_CLASSIFY_SE_LOG = join(
    KRAKEN2_PROT_CLASSIFY_SE_FILE_LOG_DIR, "{rg_id}_classify.log"
)

KRAKEN2_COMBINED_REPORT_RESULTS_DIR = join(KRAKEN2_RESULTS_DIR, "combine_reports")
KRAKEN2_COMBINED_REPORT_LOG_DIR = join(KRAKEN2_LOG_DIR, "combine_reports")
KRAKEN2_COMBINED_REPORT_FILE_RESULTS_DIR = join(
    KRAKEN2_COMBINED_REPORT_RESULTS_DIR, "{level}", "{bam_id}", "{etype}"
)
KRAKEN2_COMBINED_REPORT_FILE_LOG_DIR = join(
    KRAKEN2_COMBINED_REPORT_LOG_DIR, "{level}", "{bam_id}", "{etype}"
)
KRAKEN2_COMBINED_REPORT_FILE = join(
    KRAKEN2_COMBINED_REPORT_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKEN2_COMBINED_REPORT_LOG = join(
    KRAKEN2_COMBINED_REPORT_FILE_LOG_DIR, "{rg_id}_report.log"
)

KRAKENUNIQ_RESULTS_DIR = join(RESULTS_DIR, "krakenuniq")
KRAKENUNIQ_LOG_DIR = join(LOG_DIR, "krakenuniq")

KRAKENUNIQ_DB_DIR = join(KRAKEN_DB_BASEDIR, KRAKEN_DB_NAME)

KRAKENUNIQ_DB_BUILD_LOG_DIR = join(KRAKENUNIQ_LOG_DIR, "build", KRAKEN_DB_NAME)
KRAKENUNIQ_DB_TAX_DIR = join(KRAKENUNIQ_DB_DIR, "taxonomy")
KRAKENUNIQ_DB_TAX_LOG = join(KRAKENUNIQ_DB_BUILD_LOG_DIR, "download_taxonomy.log")
KRAKENUNIQ_DB_LIB_DIR = join(KRAKENUNIQ_DB_DIR, "library", "{kulib}")
KRAKENUNIQ_DB_LIB_LOG = join(KRAKENUNIQ_DB_BUILD_LOG_DIR, "download_{kulib}.log")
KRAKENUNIQ_DB_TAX_DONE_FILE = join(KRAKENUNIQ_DB_TAX_DIR, "krakenuniq_taxonomy.done")
KRAKENUNIQ_DB_LIB_DONE_FILE = join(KRAKENUNIQ_DB_LIB_DIR, "krakenuniq_{kulib}.done")

KRAKENUNIQ_DB_BUILD_LOG = join(KRAKENUNIQ_DB_BUILD_LOG_DIR, "krakenuniq_build.log")
KRAKENUNIQ_DB_BUILD_DONE_FILE = join(KRAKENUNIQ_DB_DIR, "krakenuniq_build.done")

KRAKENUNIQ_CLASSIFY_RESULTS_DIR = join(
    KRAKENUNIQ_RESULTS_DIR, "classify", KRAKEN_DB_NAME
)
KRAKENUNIQ_CLASSIFY_LOG_DIR = join(KRAKENUNIQ_LOG_DIR, "classify", KRAKEN_DB_NAME)
KRAKENUNIQ_CLASSIFY_FILE_RESULTS_DIR = join(
    KRAKENUNIQ_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "{etype}"
)
KRAKENUNIQ_REPORT_FILE = join(
    KRAKENUNIQ_CLASSIFY_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)

KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR = join(
    KRAKENUNIQ_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "pe"
)
KRAKENUNIQ_CLASSIFY_SE_FILE_RESULTS_DIR = join(
    KRAKENUNIQ_CLASSIFY_RESULTS_DIR, "{level}", "{bam_id}", "se"
)
KRAKENUNIQ_CLASSIFY_PE_FILE_LOG_DIR = join(
    KRAKENUNIQ_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "pe"
)
KRAKENUNIQ_CLASSIFY_SE_FILE_LOG_DIR = join(
    KRAKENUNIQ_CLASSIFY_LOG_DIR, "{level}", "{bam_id}", "se"
)

KRAKENUNIQ_CLASSIF_FASTQ_R1_FILE = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r1.fastq.gz"
)
KRAKENUNIQ_CLASSIF_FASTQ_R2_FILE = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_classif_r2.fastq.gz"
)
KRAKENUNIQ_UNCLASSIF_FASTQ_R1_FILE = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r1.fastq.gz"
)
KRAKENUNIQ_UNCLASSIF_FASTQ_R2_FILE = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_unclassif_r2.fastq.gz"
)
KRAKENUNIQ_CLASSIF_FASTQ_SE_FILE = join(
    KRAKENUNIQ_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_classif_se.fastq.gz"
)
KRAKENUNIQ_UNCLASSIF_FASTQ_SE_FILE = join(
    KRAKENUNIQ_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_unclassif_se.fastq.gz"
)
KRAKENUNIQ_REPORT_PE_FILE = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKENUNIQ_REPORT_SE_FILE = join(
    KRAKENUNIQ_CLASSIFY_SE_FILE_RESULTS_DIR, "{rg_id}_report.tsv"
)
KRAKENUNIQ_CLASSIFY_PE_LOG = join(
    KRAKENUNIQ_CLASSIFY_PE_FILE_LOG_DIR, "{rg_id}_classify.log"
)
KRAKENUNIQ_CLASSIFY_SE_LOG = join(
    KRAKENUNIQ_CLASSIFY_SE_FILE_LOG_DIR, "{rg_id}_classify.log"
)

BRACKEN_RESULTS_DIR = join(RESULTS_DIR, "bracken")
BRACKEN_LOG_DIR = join(LOG_DIR, "bracken")
BRACKEN_DB_BUILD_LOG_DIR = join(BRACKEN_LOG_DIR, "build")
BRACKEN_QUANT_RESULTS_DIR = join(BRACKEN_RESULTS_DIR, "quant")
BRACKEN_QUANT_LOG_DIR = join(BRACKEN_LOG_DIR, "quant")

BRACKEN_DB_BUILD_LOG = join(BRACKEN_DB_BUILD_LOG_DIR, "bracken_build_{readlen}.log")
BRACKEN_DB_BUILD_DONE_FILE = join(
    BRACKEN_DB_BUILD_LOG_DIR, "bracken_build_{readlen}.done"
)
BRACKEN_QUANT_FILE_RESULTS_DIR = join(
    BRACKEN_QUANT_RESULTS_DIR, "{level}", "{bam_id}", "{etype}"
)
BRACKEN_QUANT_FILE_LOG_DIR = join(
    BRACKEN_QUANT_LOG_DIR, "{level}", "{bam_id}", "{etype}"
)
BRACKEN_COUNT_FILE = join(BRACKEN_QUANT_FILE_RESULTS_DIR, "{rg_id}_counts.tsv")
BRACKEN_REPORT_FILE = join(BRACKEN_QUANT_FILE_RESULTS_DIR, "{rg_id}_report.tsv")
BRACKEN_QUANT_LOG = join(BRACKEN_QUANT_FILE_LOG_DIR, "{rg_id}_quant.log")
BRACKEN_COUNT_FILES = pd.concat(
    [
        GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] == 1].apply(
            lambda x: join(
                BRACKEN_QUANT_RESULTS_DIR,
                "sg",
                x["file_id"],
                "pe" if x["is_paired_end"] else "se",
                f"{x['file_id']}_counts.tsv",
            ),
            axis=1,
        ),
        GDC_READGRP_META_DF[GDC_READGRP_META_DF["num_uniq_read_groups"] > 1].apply(
            lambda x: join(
                BRACKEN_QUANT_RESULTS_DIR,
                "rg",
                x["file_id"],
                "pe" if x["is_paired_end"] else "se",
                f"{x['read_group_id']}_counts.tsv",
            ),
            axis=1,
        ),
    ],
    axis=0,
).tolist()

BRACKEN_MERGED_RG_RESULTS_DIR = join(BRACKEN_RESULTS_DIR, "merge_rg")
BRACKEN_MERGED_RG_LOG_DIR = join(BRACKEN_LOG_DIR, "merge_rg")
BRACKEN_MERGED_RG_COUNT_FILE = join(
    BRACKEN_MERGED_RG_RESULTS_DIR, "{bam_id}_counts.tsv"
)
BRACKEN_MERGED_RG_COUNT_LOG = join(BRACKEN_MERGED_RG_LOG_DIR, "{bam_id}_counts.log")

BRACKEN_COUNT_MATRIX_RESULTS_DIR = join(BRACKEN_RESULTS_DIR, "matrix")
BRACKEN_COUNT_MATRIX_LOG_DIR = join(BRACKEN_LOG_DIR, "matrix")
BRACKEN_COUNT_MATRIX_FILE = join(
    BRACKEN_COUNT_MATRIX_RESULTS_DIR, f"{STUDY_NAME}_count_matrix.tsv"
)
BRACKEN_COUNT_MATRIX_LOG = join(
    BRACKEN_COUNT_MATRIX_LOG_DIR, f"{STUDY_NAME}_count_matrix.log"
)
BRACKEN_BAM_COUNT_FILES = pd.concat(
    [
        GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] == 1].apply(
            lambda x: join(
                BRACKEN_QUANT_RESULTS_DIR,
                "sg",
                x["file_id"],
                "pe" if x["is_paired_end"] else "se",
                f"{x['file_id']}_counts.tsv",
            ),
            axis=1,
        ),
        GDC_BAM_META_DF[GDC_BAM_META_DF["num_uniq_read_groups"] > 1].apply(
            lambda x: join(
                BRACKEN_MERGED_RG_RESULTS_DIR,
                f"{x['file_id']}_counts.tsv",
            ),
            axis=1,
        ),
    ],
    axis=0,
).tolist()
BRACKEN_BAM_ALIQUOT_IDS = GDC_BAM_META_DF["aliquot_submitter_id"].tolist()

BOWTIE2_BUILD_THREADS = (
    workflow.cores
    if config["bowtie2"]["build"]["threads"] == "all"
    else config["bowtie2"]["build"]["threads"]
)
BOWTIE2_ALIGN_THREADS = (
    workflow.cores
    if config["bowtie2"]["align"]["threads"] == "all"
    else config["bowtie2"]["align"]["threads"]
)
KRAKEN2_BUILD_THREADS = (
    workflow.cores
    if config["kraken2"]["build"]["threads"] == "all"
    else config["kraken2"]["build"]["threads"]
)
KRAKEN2_CLASSIFY_THREADS = (
    workflow.cores
    if config["kraken2"]["classify"]["threads"] == "all"
    else config["kraken2"]["classify"]["threads"]
)
KRAKENUNIQ_DOWNLOAD_THREADS = (
    workflow.cores
    if config["krakenuniq"]["download"]["threads"] == "all"
    else config["krakenuniq"]["download"]["threads"]
)
KRAKENUNIQ_BUILD_THREADS = (
    workflow.cores
    if config["krakenuniq"]["build"]["threads"] == "all"
    else config["krakenuniq"]["build"]["threads"]
)
KRAKENUNIQ_CLASSIFY_THREADS = (
    workflow.cores
    if config["krakenuniq"]["classify"]["threads"] == "all"
    else config["krakenuniq"]["classify"]["threads"]
)
BRACKEN_BUILD_THREADS = (
    workflow.cores
    if config["bracken"]["build"]["threads"] == "all"
    else config["bracken"]["build"]["threads"]
)

BIOBAMBAM2_BAMTOFASTQ_WRAPPER = join(
    LOCAL_WRAPPERS_BASE_URL, "bio/biobambam2/bamtofastq"
)
BOWTIE2_BUILD_WRAPPER = join(PUBLIC_WRAPPERS_VERSION, "bio/bowtie2/build")
BOWTIE2_ALIGN_WRAPPER = join(PUBLIC_WRAPPERS_VERSION, "bio/bowtie2/align")
KRAKEN2_BUILD_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/kraken2/build")
KRAKEN2_BUILD_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/kraken2/build")
KRAKEN2_CLASSIFY_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/kraken2/classify")
KRAKENTOOLS_COMBINE_KREPORTS_WRAPPER = join(
    LOCAL_WRAPPERS_BASE_URL, "bio/krakentools/combine_kreports"
)
KRAKENUNIQ_DOWNLOAD_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/krakenuniq/download")
KRAKENUNIQ_BUILD_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/krakenuniq/build")
KRAKENUNIQ_CLASSIFY_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/krakenuniq/classify")
BRACKEN_BUILD_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/bracken/build")
BRACKEN_QUANT_WRAPPER = join(LOCAL_WRAPPERS_BASE_URL, "bio/bracken/quant")


include: join(RULES_DIR, "gdc_file.smk")
include: join(RULES_DIR, "host_filter.smk")
include: join(RULES_DIR, "read_classif.smk")
include: join(RULES_DIR, "read_quant.smk")


wildcard_constraints:
    **{
        w: "|".join(set([re.escape(str(v)) for v in l]))
        for w, l in EXPAND_PARAMS.items()
    },
    bam_id="[0-9a-f\\-]+",
    rg_id="[0-9a-f\\-]+",
    level="sg|rg",
    etype="pe|se",


rule all:
    input:
        # HOST_REF_FASTA_FILE,
        # GDC_UNMAPPED_BAM_FILES,
        # GDC_UNMAPPED_FASTQ_FILES,
        # BOWTIE2_HOST_INDEX_FILES,
        # BOWTIE2_FILTERED_SAM_FILES,
        # BOWTIE2_FILTERED_FASTQ_FILES,
        # BRACKEN_COUNT_FILES,
        BRACKEN_COUNT_MATRIX_FILE,


def clean(*dirs):
    for clean_dir in dirs:
        if exists(clean_dir):
            rmtree(clean_dir)
        for dirpath, dirnames, filenames in sorted(walk(getcwd())):
            for name in dirnames:
                if name == "__pycache__":
                    pycache_dir = join(dirpath, name)
                    if exists(pycache_dir):
                        rmtree(pycache_dir)


rule clean:
    run:
        clean(RESULTS_DIR, LOG_DIR)


rule clean_all:
    run:
        clean(RESOURCES_DIR, RESULTS_DIR, LOG_DIR)
